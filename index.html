<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saree Ordering System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#4f46e5',
              secondary: '#10b981',
            }
          }
        }
      }
    </script>
    <script type="module">
        // IMPORTANT: Make sure you use the ES Module version of the Supabase client
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://omuwfgyeqjenreojqtbw.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tdXdmZ3llcWplbnJlb2pxdGJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTI2MzcsImV4cCI6MjA3MjEyODYzN30.EtKzbfFhrcaHfaaIbrVloRU95FncyrAEAogMhAX4csA';

        // The email address for display purposes. Login is password-only.
        const ADMIN_EMAIL = 'rupaniabhishek487@gmail.com'; 
        // The password for the admin panel.
        const ADMIN_PASSWORD = 'sareeadmin2025';
        // --- END CONFIGURATION ---

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM ELEMENTS ---
        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const staffView = document.getElementById('staff-view');
        const appTitle = document.getElementById('app-title');
        const userDisplay = document.getElementById('user-display');
        const logoutButton = document.getElementById('logout-button');

        // Login form
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginMessage = document.getElementById('login-message');
        const loginTitle = document.getElementById('login-title');
        const roleSwitcherBtns = document.querySelectorAll('.role-switcher-btn');
        const emailInputWrapper = document.getElementById('email-input-wrapper');
        const rememberMeCheckbox = document.getElementById('remember-me');

        // Admin view elements
        const adminTabs = document.querySelectorAll('.admin-tab');
        const adminPanels = document.querySelectorAll('.admin-panel');
        const productTableBody = document.getElementById('product-table-body');
        const productModal = document.getElementById('product-modal');
        const productModalTitle = document.getElementById('product-modal-title');
        const productFormInModal = document.getElementById('product-form-in-modal');
        const cancelModalButton = document.getElementById('cancel-modal-button');
        const productIdInput = document.getElementById('product-id');
        const orderDashboardContent = document.getElementById('order-dashboard-content');
        const imageUrlsContainer = document.getElementById('image-urls-container');
        const addStaffForm = document.getElementById('add-staff-form');
        const staffMessage = document.getElementById('staff-message');
        const staffListContainer = document.getElementById('staff-list-container');
        
        // Staff view elements
        const staffProductGrid = document.getElementById('staff-product-grid');
        const currentOrderPartyName = document.getElementById('current-order-party-name');
        const currentOrderItems = document.getElementById('current-order-items');
        const currentOrderNotes = document.getElementById('current-order-notes');
        const currentOrderTotal = document.getElementById('current-order-total');
        const submitOrderButton = document.getElementById('submit-order-button');
        const orderMessage = document.getElementById('order-message');
        
        // --- STATE ---
        let currentUser = null;
        let products = [];
        let currentOrder = {
            partyName: '',
            items: [],
            notes: '',
            total: 0
        };
        let loginRole = 'staff';

        // --- HELPER FUNCTIONS ---
        function showView(viewId) {
            [loadingView, loginView, adminView, staffView].forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
        }

        // --- AUTHENTICATION ---
        async function handleLogin(e) {
            e.preventDefault();
            const password = loginPasswordInput.value;
            loginMessage.textContent = 'Logging in...';

            if (loginRole === 'admin') {
                if (password === ADMIN_PASSWORD) {
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    if (rememberMeCheckbox.checked) {
                        localStorage.setItem('adminPassword', password);
                    } else {
                        localStorage.removeItem('adminPassword');
                    }
                    loginMessage.textContent = '';
                    loginForm.reset();
                    await checkUserSession();
                } else {
                    loginMessage.textContent = 'Error: Invalid password.';
                }
                return;
            }
            
            // --- Staff Login Logic ---
            const email = loginEmailInput.value;
             if (email === ADMIN_EMAIL) {
                loginMessage.textContent = 'Error: Please use the Admin login for this email.';
                return;
            }

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                loginMessage.textContent = `Error: ${error.message}`;
                return;
            }

            if (data.user) {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('staffEmail', email);
                    localStorage.setItem('staffPassword', password);
                    localStorage.removeItem('adminPassword'); 
                } else {
                    localStorage.removeItem('staffEmail');
                    localStorage.removeItem('staffPassword');
                    localStorage.removeItem('adminPassword');
                }
                loginMessage.textContent = '';
                await checkUserSession();
            }
        }

        async function handleLogout() {
            if (currentUser && currentUser.is_admin) {
                sessionStorage.removeItem('isAdminLoggedIn');
            } else {
                await supabase.auth.signOut();
            }
            currentUser = null;
            userDisplay.textContent = '';
            logoutButton.classList.add('hidden');
            appTitle.textContent = 'Saree Ordering System';
            showView('login-view');
        }

        async function checkUserSession() {
            if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                currentUser = { email: ADMIN_EMAIL, is_admin: true };
                userDisplay.textContent = 'Logged in as: Admin';
                logoutButton.classList.remove('hidden');
                appTitle.textContent = 'Admin Panel';
                await initializeAdminView();
                showView('admin-view');
                loadingView.classList.add('hidden');
                return;
            }

            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                userDisplay.textContent = `Logged in as: ${currentUser.email}`;
                logoutButton.classList.remove('hidden');
                
                if (currentUser.email === ADMIN_EMAIL) {
                    // This case is a fallback, but primary admin login is password-only.
                    appTitle.textContent = 'Admin Panel';
                    await initializeAdminView();
                    showView('admin-view');
                } else {
                    appTitle.textContent = 'Staff Ordering Panel';
                    await initializeStaffView();
                    showView('staff-view');
                }
            } else {
                showView('login-view');
            }
            loadingView.classList.add('hidden');
        }

        
        // --- ADMIN PANEL ---
        async function initializeAdminView() {
            await fetchProducts(true);
            renderProductTable();
            await renderOrderDashboard();
            await fetchAndRenderStaffList();
        }

        async function fetchProducts(isAdmin = false) {
            // Admin gets all columns, staff gets limited columns for security
            const columns = isAdmin ? '*' : 'id, unique_number, name, rate, image_url, color, description';
            const { data, error } = await supabase.from('products').select(columns).order('unique_number', { ascending: true });
            
            if (error) {
                console.error('Error fetching products:', error);
                alert('Could not fetch products.');
                return;
            }
            products = data;
        }

        function renderProductTable() {
            productTableBody.innerHTML = '';
            products.forEach(p => {
                const firstImage = p.image_url ? p.image_url.split(',')[0].trim() : 'https://placehold.co/100x100/eee/ccc?text=No+Image';
                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-sm">${p.unique_number}</td>
                        <td class="p-3"><img src="${firstImage}" alt="${p.name}" class="h-16 w-16 object-cover rounded-md shadow"></td>
                        <td class="p-3 font-medium text-gray-800 text-sm">${p.name}</td>
                        <td class="p-3 text-sm">${formatCurrency(p.rate)}</td>
                        <td class="p-3 text-sm">${p.color}</td>
                        <td class="p-3 text-sm">${p.weaver_name}</td>
                        <td class="p-3 max-w-[150px] truncate text-sm">${p.description || ''}</td>
                        <td class="p-3 text-sm">
                            <button data-id="${p.id}" class="edit-product-btn bg-indigo-500 text-white px-3 py-1 rounded-md shadow-sm hover:bg-indigo-600 transition">Edit</button>
                            <button data-id="${p.id}" class="delete-product-btn bg-red-500 text-white px-3 py-1 rounded-md shadow-sm hover:bg-red-600 transition mt-1">Delete</button>
                        </td>
                    </tr>
                `;
                productTableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        async function renderOrderDashboard() {
            orderDashboardContent.innerHTML = '<div class="text-center p-8"><p>Loading orders...</p></div>';
            const { data: orders, error } = await supabase
                .from('orders')
                .select(`
                    *,
                    order_items (
                        products (*)
                    ),
                    profiles (email)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Error fetching orders:", error);
                orderDashboardContent.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert"><p>Error fetching orders: ${error.message}</p></div>`;
                return;
            }

            if (orders.length === 0) {
                orderDashboardContent.innerHTML = '<div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-gray-500">No orders have been placed yet.</p></div>';
                return;
            }

            const ordersByParty = orders.reduce((acc, order) => {
                const party = order.party_name;
                if (!acc[party]) {
                    acc[party] = { items: [], total: 0, notes: [] };
                }
                order.order_items.forEach(item => {
                    if(item.products) {
                       acc[party].items.push(item.products);
                       acc[party].total += item.products.rate;
                    }
                });
                if(order.notes) acc[party].notes.push(order.notes);
                return acc;
            }, {});

            let html = '';
            for (const partyName in ordersByParty) {
                const partyData = ordersByParty[partyName];
                html += `
                    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-6">
                        <div class="md:flex justify-between items-center mb-4">
                            <h3 class="text-xl md:text-2xl font-bold text-gray-800">${partyName}</h3>
                            <div class="text-left md:text-right mt-2 md:mt-0">
                                <p class="text-lg md:text-xl font-semibold text-green-600">Total Sale: ${formatCurrency(partyData.total)}</p>
                                <p class="text-md font-semibold text-gray-600">Total Sarees: ${partyData.items.length}</p>
                            </div>
                        </div>
                        
                        <div class="mt-4 bg-gray-50 p-3 rounded">
                            <h4 class="font-bold text-gray-700">Notes:</h4>
                            <ul class="list-disc pl-5 text-gray-600 text-sm">
                                ${partyData.notes.filter(n => n).map(note => `<li>${note}</li>`).join('') || '<li>No notes.</li>'}
                            </ul>
                        </div>

                        <div class="mt-4">
                            <h4 class="font-bold text-gray-700 mb-2">Items Ordered:</h4>
                            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 md:gap-4">
                                ${partyData.items.map(item => {
                                    const itemImage = item.image_url ? item.image_url.split(',')[0].trim() : 'https://placehold.co/100x100/eee/ccc?text=No+Image';
                                    return `
                                    <div class="border p-2 rounded-lg text-center bg-gray-50 hover:shadow-lg transition">
                                        <img src="${itemImage}" class="w-full h-20 md:h-28 object-cover rounded-md mx-auto shadow-sm">
                                        <p class="text-xs md:text-sm font-semibold mt-2 truncate">${item.name}</p>
                                        <p class="text-xs text-gray-500">#${item.unique_number}</p>
                                        <p class="text-xs md:text-sm font-bold text-indigo-600">${formatCurrency(item.rate)}</p>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            orderDashboardContent.innerHTML = html;
        }

        function openProductModal(product = null) {
            productFormInModal.reset();
            productIdInput.value = '';

            // Clear previous dynamic image inputs
            const dynamicImageInputs = imageUrlsContainer.querySelectorAll('.dynamic-image-input');
            dynamicImageInputs.forEach(input => input.remove());

            if (product) {
                // Editing existing product
                productModalTitle.textContent = 'Edit Saree';
                productIdInput.value = product.id;
                document.getElementById('product-unique_number').value = product.unique_number;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-rate').value = product.rate;
                document.getElementById('product-color').value = product.color;
                document.getElementById('product-weaver_name').value = product.weaver_name;
                document.getElementById('product-description').value = product.description || '';

                const firstImageInput = imageUrlsContainer.querySelector('input[name="image_url"]');
                const urls = product.image_url ? product.image_url.split(',') : [];
                firstImageInput.value = urls[0] || '';
                if (urls.length > 1) {
                    urls.slice(1).forEach(url => addImageUrlInput(url));
                }

            } else {
                // Adding new product
                productModalTitle.textContent = 'Add New Saree';
                imageUrlsContainer.querySelector('input[name="image_url"]').value = '';
            }
            productModal.classList.remove('hidden');
        }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());

            // Handle multiple image URLs
            const imageUrlInputs = productFormInModal.querySelectorAll('input[name="image_url"]');
            const imageUrls = Array.from(imageUrlInputs).map(input => input.value.trim()).filter(url => url);
            productData.image_url = imageUrls.join(',');
            
            const id = productData.id;
            delete productData.id;

            productData.rate = parseFloat(productData.rate);
            
            let error;
            if (id) {
                const { error: updateError } = await supabase.from('products').update(productData).eq('id', id);
                error = updateError;
            } else {
                const { error: insertError } = await supabase.from('products').insert([productData]);
                error = insertError;
            }

            if (error) {
                console.error('Error saving product:', error);
                alert(`Error: ${error.message}`);
            } else {
                productModal.classList.add('hidden');
                await fetchProducts(true);
                renderProductTable();
            }
        }
        
        async function handleDeleteProduct(id) {
            if (!confirm('Are you sure you want to delete this saree? This action cannot be undone.')) {
                return;
            }
            const { error } = await supabase.from('products').delete().eq('id', id);
            if (error) {
                console.error('Error deleting product:', error);
                alert(`Error: ${error.message}`);
            } else {
                await fetchProducts(true);
                renderProductTable();
            }
        }

        async function handleStaffRegistration(e) {
            e.preventDefault();
            const name = document.getElementById('staff-name').value;
            const email = document.getElementById('staff-email').value;
            const password = document.getElementById('staff-password').value;
            
            staffMessage.textContent = 'Registering...';
            staffMessage.className = 'mt-4 text-center font-medium text-gray-600';

            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: name
                    }
                }
            });

            if (error) {
                staffMessage.textContent = `Error: ${error.message}`;
                staffMessage.className = 'mt-4 text-center font-medium text-red-500';
            } else if (data.user) {
                // This is a workaround to prevent the admin from being logged out.
                // We immediately sign out the new user's session created by signUp.
                await supabase.auth.signOut();
                
                staffMessage.textContent = 'Staff registered successfully!';
                staffMessage.className = 'mt-4 text-center font-medium text-green-500';
                addStaffForm.reset();
                await fetchAndRenderStaffList(); // Refresh the staff list
            }
        }

        async function fetchAndRenderStaffList() {
            staffListContainer.innerHTML = '<p>Loading staff...</p>';
            const { data, error } = await supabase
                .from('profiles')
                .select('full_name, email');

            if (error) {
                staffListContainer.innerHTML = '<p class="text-red-500">Could not load staff list.</p>';
                console.error("Error fetching staff:", error);
                return;
            }

            const staffList = data.filter(profile => profile.email !== ADMIN_EMAIL);

            if (staffList.length === 0) {
                staffListContainer.innerHTML = '<p class="text-gray-500">No staff members have been added yet.</p>';
                return;
            }

            staffListContainer.innerHTML = `
                <ul class="divide-y divide-gray-200">
                    ${staffList.map(staff => `
                        <li class="py-3 flex justify-between items-center">
                            <div>
                                <p class="font-medium text-gray-800">${staff.full_name || 'Name not set'}</p>
                                <p class="text-sm text-gray-500">${staff.email}</p>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        }


        // --- STAFF PANEL ---
        async function initializeStaffView() {
            resetOrder();
            await fetchProducts(false);
            renderStaffProductGrid();
        }

        function renderStaffProductGrid() {
            staffProductGrid.innerHTML = '';
             products.forEach(p => {
                const isAdded = currentOrder.items.some(item => item.id === p.id);
                const buttonHtml = isAdded
                    ? `<button class="w-full bg-gray-400 text-white font-bold py-2 px-4 rounded-lg mt-2 cursor-not-allowed" disabled>Added</button>`
                    : `<button data-id="${p.id}" class="add-to-order-btn w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-2 px-4 rounded-lg mt-2 hover:from-green-600 hover:to-emerald-700 shadow-lg transform hover:scale-105 transition-all duration-200">Add to Order</button>`;
                
                const firstImage = p.image_url ? p.image_url.split(',')[0].trim() : 'https://placehold.co/400x400/eee/ccc?text=No+Image';

                const card = `
                    <div class="border rounded-xl p-4 shadow-lg bg-white transition-transform transform hover:-translate-y-1 duration-300 flex flex-col">
                        <img src="${firstImage}" alt="${p.name}" class="w-full h-52 object-cover rounded-lg mb-3 shadow-md">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-gray-800">${p.name}</h3>
                            <div class="flex justify-between items-center text-sm text-gray-500 mt-1">
                              <span>#${p.unique_number}</span>
                            </div>
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${p.color.split(',').map(c => `<span class="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-1 rounded-full">${c.trim()}</span>`).join('')}
                            </div>
                            <p class="text-sm text-gray-600 mt-2">${p.description || ''}</p>
                        </div>
                        <div class="mt-auto pt-2">
                          <p class="font-semibold text-2xl text-primary mt-2">${formatCurrency(p.rate)}</p>
                          ${buttonHtml}
                        </div>
                    </div>
                `;
                staffProductGrid.insertAdjacentHTML('beforeend', card);
            });
        }
        
        function handleAddToOrder(productId) {
            const partyName = currentOrderPartyName.value.trim();
            if (!partyName) {
                alert('Please enter a Party Name before adding items.');
                currentOrderPartyName.focus();
                return;
            }
            if(currentOrder.partyName && currentOrder.partyName !== partyName) {
                if(!confirm('Changing party name will clear the current order. Continue?')) {
                    currentOrderPartyName.value = currentOrder.partyName;
                    return;
                }
                resetOrder();
                currentOrderPartyName.value = partyName;
            }
            currentOrder.partyName = partyName;

            const product = products.find(p => p.id === productId);
            if (product) {
                currentOrder.items.push(product);
                updateCurrentOrderDisplay();
                renderStaffProductGrid();
            }
        }
        
        function handleRemoveFromOrder(productId) {
            currentOrder.items = currentOrder.items.filter(item => item.id !== productId);
            updateCurrentOrderDisplay();
            renderStaffProductGrid();
        }

        function updateCurrentOrderDisplay() {
            currentOrderItems.innerHTML = '';
            let total = 0;
            if (currentOrder.items.length === 0) {
                currentOrderItems.innerHTML = '<p class="text-gray-500 text-center py-4">No items added yet.</p>';
            } else {
                 currentOrder.items.forEach(item => {
                    total += item.rate;
                    const itemHtml = `
                        <li class="flex justify-between items-center py-3 border-b border-gray-200">
                            <div>
                                <p class="font-semibold text-gray-800">${item.name} (#${item.unique_number})</p>
                                <p class="text-sm text-gray-600">${formatCurrency(item.rate)}</p>
                            </div>
                            <button data-id="${item.id}" class="remove-from-order-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                        </li>
                    `;
                    currentOrderItems.insertAdjacentHTML('beforeend', itemHtml);
                });
            }
            currentOrder.total = total;
            currentOrderTotal.textContent = formatCurrency(total);
        }

        async function handleSubmitOrder() {
            if (!currentOrder.partyName || currentOrder.items.length === 0) {
                alert('Please provide a party name and add at least one item.');
                return;
            }
            
            submitOrderButton.disabled = true;
            submitOrderButton.textContent = 'Submitting...';
            orderMessage.textContent = '';

            const { data: orderData, error: orderError } = await supabase
                .from('orders')
                .insert({
                    party_name: currentOrder.partyName,
                    notes: currentOrderNotes.value,
                    total_amount: currentOrder.total,
                    staff_id: currentUser.id
                })
                .select()
                .single();

            if (orderError) {
                console.error('Error creating order:', orderError);
                orderMessage.textContent = `Error: ${orderError.message}`;
                orderMessage.className = 'mt-4 text-center font-semibold text-red-500';
                submitOrderButton.disabled = false;
                submitOrderButton.textContent = 'Submit Order';
                return;
            }
            
            const orderItemsData = currentOrder.items.map(item => ({
                order_id: orderData.id,
                product_id: item.id
            }));
            
            const { error: itemsError } = await supabase.from('order_items').insert(orderItemsData);
            
            if (itemsError) {
                console.error('Error adding order items:', itemsError);
                await supabase.from('orders').delete().eq('id', orderData.id);
                orderMessage.textContent = `Error saving items. Order cancelled.`;
                orderMessage.className = 'mt-4 text-center font-semibold text-red-500';
            } else {
                orderMessage.textContent = 'Order submitted successfully!';
                orderMessage.className = 'mt-4 text-center font-semibold text-green-500';
                resetOrder();
                renderStaffProductGrid();
            }

            setTimeout(() => { orderMessage.textContent = '' }, 5000);
            submitOrderButton.disabled = false;
            submitOrderButton.textContent = 'Submit Order';
        }
        
        function resetOrder() {
            currentOrder = { partyName: '', items: [], notes: '', total: 0 };
            currentOrderPartyName.value = '';
            currentOrderNotes.value = '';
            updateCurrentOrderDisplay();
        }

        function populateLoginFormFromStorage() {
            if (loginRole === 'staff') {
                const savedEmail = localStorage.getItem('staffEmail');
                const savedPassword = localStorage.getItem('staffPassword');
                if (savedEmail && savedPassword) {
                    loginEmailInput.value = savedEmail;
                    loginPasswordInput.value = savedPassword;
                    rememberMeCheckbox.checked = true;
                } else {
                    loginEmailInput.value = '';
                    loginPasswordInput.value = '';
                    rememberMeCheckbox.checked = false;
                }
            } else { // admin
                const savedPassword = localStorage.getItem('adminPassword');
                loginEmailInput.value = ADMIN_EMAIL;
                if (savedPassword) {
                    loginPasswordInput.value = savedPassword;
                    rememberMeCheckbox.checked = true;
                } else {
                    loginPasswordInput.value = '';
                    rememberMeCheckbox.checked = false;
                }
            }
        }

        function addImageUrlInput(url = '') {
            const div = document.createElement('div');
            div.className = 'flex items-center mt-2 dynamic-image-input';
            div.innerHTML = `
                <input type="url" name="image_url" value="${url}" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                <button type="button" class="remove-image-btn ml-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                </button>
            `;
            imageUrlsContainer.appendChild(div);
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('DOMContentLoaded', () => {
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);

            document.getElementById('add-image-btn').addEventListener('click', () => addImageUrlInput());

            imageUrlsContainer.addEventListener('click', e => {
                if (e.target.closest('.remove-image-btn')) {
                    e.target.closest('.dynamic-image-input').remove();
                }
            });

            roleSwitcherBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    roleSwitcherBtns.forEach(b => b.classList.remove('bg-primary', 'text-white'));
                    btn.classList.add('bg-primary', 'text-white');
                    loginRole = btn.dataset.role;
                    loginTitle.textContent = `${loginRole.charAt(0).toUpperCase() + loginRole.slice(1)} Login`;
                    
                    if (loginRole === 'admin') {
                        emailInputWrapper.classList.add('hidden');
                    } else {
                        emailInputWrapper.classList.remove('hidden');
                    }
                    populateLoginFormFromStorage();
                });
            });
            
            // Admin listeners
            adminTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    adminTabs.forEach(t => t.classList.remove('border-primary', 'text-primary'));
                    tab.classList.add('border-primary', 'text-primary');
                    adminPanels.forEach(panel => panel.classList.add('hidden'));
                    document.getElementById(tab.dataset.target).classList.remove('hidden');
                });
            });
            
            document.getElementById('add-product-btn').addEventListener('click', () => openProductModal());
            cancelModalButton.addEventListener('click', () => productModal.classList.add('hidden'));
            productFormInModal.addEventListener('submit', handleProductFormSubmit);
            addStaffForm.addEventListener('submit', handleStaffRegistration);
            
            productTableBody.addEventListener('click', e => {
                if (e.target.closest('.edit-product-btn')) {
                    const id = parseInt(e.target.closest('.edit-product-btn').dataset.id);
                    const product = products.find(p => p.id === id);
                    openProductModal(product);
                }
                if (e.target.closest('.delete-product-btn')) {
                    const id = parseInt(e.target.closest('.delete-product-btn').dataset.id);
                    handleDeleteProduct(id);
                }
            });

            // Staff listeners
            staffProductGrid.addEventListener('click', e => {
                if (e.target.closest('.add-to-order-btn')) {
                    const id = parseInt(e.target.closest('.add-to-order-btn').dataset.id);
                    handleAddToOrder(id);
                }
            });
            
            currentOrderItems.addEventListener('click', e => {
                if (e.target.closest('.remove-from-order-btn')) {
                    const id = parseInt(e.target.closest('.remove-from-order-btn').dataset.id);
                    handleRemoveFromOrder(id);
                }
            });

            submitOrderButton.addEventListener('click', handleSubmitOrder);

            populateLoginFormFromStorage(); // Populate on initial load for default role
            checkUserSession();
        });

    </script>
</head>
<body class="bg-slate-100 font-sans">
    <header class="bg-white shadow-md sticky top-0 z-20">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <h1 id="app-title" class="text-xl md:text-2xl font-bold text-gray-800">Saree Ordering System</h1>
            <div>
                <span id="user-display" class="text-gray-700 mr-4 text-sm md:text-base"></span>
                <button id="logout-button" class="bg-red-500 text-white px-3 py-1 md:px-4 md:py-2 rounded-lg shadow hover:bg-red-600 transition hidden">Logout</button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-6">
        <!-- Loading View -->
        <div id="loading-view">
            <p class="text-center text-xl mt-10">Loading application...</p>
        </div>

        <!-- Login View -->
        <div id="login-view" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl mt-10 hidden">
            <div class="mb-6">
                <div class="flex border border-gray-300 rounded-lg p-1">
                    <button data-role="staff" class="role-switcher-btn w-1/2 p-2 rounded-md text-center font-semibold transition bg-primary text-white">Staff</button>
                    <button data-role="admin" class="role-switcher-btn w-1/2 p-2 rounded-md text-center font-semibold transition">Admin</button>
                </div>
            </div>
            <h2 id="login-title" class="text-3xl font-bold text-center mb-6 text-gray-800">Staff Login</h2>
            <form id="login-form">
                <div id="email-input-wrapper" class="mb-4">
                    <label for="login-email" class="block text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-primary focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                    </div>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-700 transition shadow-lg">Login</button>
                <p id="login-message" class="text-red-500 mt-4 text-center font-medium"></p>
            </form>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="hidden">
            <div class="border-b border-gray-200 bg-white rounded-t-lg p-2 overflow-x-auto">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button data-target="order-dashboard" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-primary text-primary">Order Dashboard</button>
                    <button data-target="product-management" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Manage Sarees</button>
                    <button data-target="staff-management" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Manage Staff</button>
                </nav>
            </div>
            
            <div id="order-dashboard" class="admin-panel mt-6">
                <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">Party-wise Order Summary</h2>
                <div id="order-dashboard-content"></div>
            </div>

            <div id="product-management" class="admin-panel mt-6 hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-0">Saree Inventory</h2>
                    <button id="add-product-btn" class="bg-secondary text-white px-5 py-2 rounded-lg shadow hover:bg-emerald-600 transition font-semibold w-full md:w-auto">Add New Saree</button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr class="border-b">
                                <th class="p-3 text-sm">Unique No.</th>
                                <th class="p-3 text-sm">Image</th>
                                <th class="p-3 text-sm">Name</th>
                                <th class="p-3 text-sm">Rate</th>
                                <th class="p-3 text-sm">Color</th>
                                <th class="p-3 text-sm">Weaver Name</th>
                                <th class="p-3 text-sm">Description</th>
                                <th class="p-3 text-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="staff-management" class="admin-panel mt-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Add Staff Form -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Add New Staff</h3>
                        <form id="add-staff-form">
                            <div class="mb-4">
                                <label for="staff-name" class="block text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="staff-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            </div>
                            <div class="mb-4">
                                <label for="staff-email" class="block text-gray-700 mb-1">Email</label>
                                <input type="email" id="staff-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            </div>
                            <div class="mb-4">
                                <label for="staff-password" class="block text-gray-700 mb-1">Password</label>
                                <input type="password" id="staff-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            </div>
                            <button type="submit" class="w-full bg-secondary text-white py-3 rounded-lg font-bold text-lg hover:bg-emerald-600 transition shadow-lg">Register Staff</button>
                            <p id="staff-message" class="mt-4 text-center font-medium"></p>
                        </form>
                    </div>
                    <!-- Staff List -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Current Staff</h3>
                        <div id="staff-list-container" class="max-h-96 overflow-y-auto">
                            <!-- Staff list will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Product Modal -->
        <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30">
            <div class="bg-white rounded-lg p-6 md:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <h3 id="product-modal-title" class="text-2xl font-bold mb-6">Add New Saree</h3>
                <form id="product-form-in-modal">
                    <input type="hidden" id="product-id" name="id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="product-unique_number" class="block text-sm font-medium text-gray-700">Unique Number</label>
                            <input type="text" name="unique_number" id="product-unique_number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                        </div>
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-gray-700">Saree Name</label>
                            <input type="text" name="name" id="product-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="product-rate" class="block text-sm font-medium text-gray-700">Rate (INR)</label>
                            <input type="number" name="rate" id="product-rate" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="product-color" class="block text-sm font-medium text-gray-700">Colors (comma-separated)</label>
                            <input type="text" name="color" id="product-color" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                         <div class="col-span-1 md:col-span-2">
                            <label for="product-image_url" class="block text-sm font-medium text-gray-700">Image URLs</label>
                            <div id="image-urls-container">
                                <div class="flex items-center mt-1">
                                    <input type="url" name="image_url" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                                    <button type="button" id="add-image-btn" class="ml-2 bg-green-500 text-white p-2 rounded-full hover:bg-green-600 flex items-center justify-center flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="product-weaver_name" class="block text-sm font-medium text-gray-700">Weaver Name (Admin Only)</label>
                            <input type="text" name="weaver_name" id="product-weaver_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="product-description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea name="description" id="product-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button type="button" id="cancel-modal-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Saree</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Staff View -->
        <div id="staff-view" class="hidden bg-indigo-50 p-2 md:p-6 rounded-xl">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Product Grid -->
                <div class="lg:col-span-2">
                     <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">Available Sarees</h2>
                     <div id="staff-product-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6">
                        <!-- Product cards will be injected here -->
                     </div>
                </div>

                <!-- Current Order -->
                <div class="lg:sticky lg:top-24 h-fit">
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-2xl">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Current Order</h2>
                        <div class="mb-4">
                            <label for="current-order-party-name" class="block text-gray-700 font-semibold mb-1">Party Name</label>
                            <input type="text" id="current-order-party-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter party or client name">
                        </div>
                        <div class="mb-4">
                            <h3 class="font-semibold mb-2 text-gray-800">Items</h3>
                            <ul id="current-order-items" class="max-h-60 overflow-y-auto pr-2">
                               <p class="text-gray-500 text-center py-4">No items added yet.</p>
                            </ul>
                        </div>
                        <div class="border-t-2 border-dashed pt-4 mb-4">
                            <div class="flex justify-between items-center text-xl font-bold text-gray-800">
                                <span>Total:</span>
                                <span id="current-order-total" class="text-primary">0.00</span>
                            </div>
                        </div>
                        <div class="mb-4">
                             <label for="current-order-notes" class="block text-gray-700 font-semibold mb-1">Notes</label>
                             <textarea id="current-order-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Add any special requests..."></textarea>
                        </div>
                        <button id="submit-order-button" class="w-full bg-gradient-to-r from-primary to-indigo-600 text-white py-3 rounded-lg text-lg font-bold hover:from-indigo-600 hover:to-indigo-700 shadow-xl transform hover:scale-105 transition-all duration-300">Submit Order</button>
                        <p id="order-message" class="mt-4 text-center font-semibold"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

</body>
</html>

