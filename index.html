<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saree Ordering System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#4f46e5',
              secondary: '#10b981',
            }
          }
        }
      }
    </script>
    <style>
        /* Minimal styles can be added here if needed */
    </style>
    <script type="module">
        // IMPORTANT: Make sure you use the ES Module version of the Supabase client
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://omuwfgyeqjenreojqtbw.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tdXdmZ3llcWplbnJlb2pxdGJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTI2MzcsImV4cCI6MjA3MjEyODYzN30.EtKzbfhrcaHfaaIbrVloRU95FncyrAEAogMhAX4csA';
        
        // This key allows the admin panel to bypass security policies to manage products and staff.
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tdXdmZ3llcWplbnJlb2pxdGJ3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjU1MjYzNywiZXhwIjoyMDcyMTI4NjM3fQ.QpFzPiItqFoIB9g4aVg3wr4cjkzkVliy-0RUdSuGSoU';

        // The email address for display purposes. Login is password-only.
        const ADMIN_EMAIL = 'rupaniabhishek487@gmail.com'; 
        // The password for the admin panel.
        let ADMIN_PASSWORD = 'sareeadmin2025';
        // --- END CONFIGURATION ---

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM ELEMENTS ---
        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const staffView = document.getElementById('staff-view');
        const appTitle = document.getElementById('app-title');
        const userDisplay = document.getElementById('user-display');
        const logoutButton = document.getElementById('logout-button');

        // Login form
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginMessage = document.getElementById('login-message');
        const loginTitle = document.getElementById('login-title');
        const roleSwitcherBtns = document.querySelectorAll('.role-switcher-btn');
        const emailInputWrapper = document.getElementById('email-input-wrapper');
        const rememberMeCheckbox = document.getElementById('remember-me');

        // Admin view elements
        const adminTabs = document.querySelectorAll('.admin-tab');
        const adminPanels = document.querySelectorAll('.admin-panel');
        const productTableBody = document.getElementById('product-table-body');
        const productModal = document.getElementById('product-modal');
        const productModalTitle = document.getElementById('product-modal-title');
        const productFormInModal = document.getElementById('product-form-in-modal');
        const cancelModalButton = document.getElementById('cancel-modal-button');
        const productIdInput = document.getElementById('product-id');
        const orderDashboardContent = document.getElementById('order-dashboard-content');
        const imageUrlsContainer = document.getElementById('image-urls-container');
        const addStaffForm = document.getElementById('add-staff-form');
        const staffMessage = document.getElementById('staff-message');
        const staffListContainer = document.getElementById('staff-list-container');
        const changePasswordForm = document.getElementById('change-password-form');
        const changePasswordMessage = document.getElementById('change-password-message');
        
        // Staff view elements
        const staffTabs = document.querySelectorAll('.staff-tab');
        const staffPanels = document.querySelectorAll('.staff-panel');
        const staffProductGrid = document.getElementById('staff-product-grid');
        const staffSearchInput = document.getElementById('staff-search-input');
        const myOrdersContent = document.getElementById('my-orders-content');
        const currentOrderPartyName = document.getElementById('current-order-party-name');
        const currentOrderItems = document.getElementById('current-order-items');
        const currentOrderNotes = document.getElementById('current-order-notes');
        const currentOrderTotal = document.getElementById('current-order-total');
        const submitOrderButton = document.getElementById('submit-order-button');
        const orderMessage = document.getElementById('order-message');
        const addToOrderModal = document.getElementById('add-to-order-modal');
        
        // --- STATE ---
        let currentUser = null;
        let products = [];
        let currentOrder = {
            partyName: '',
            items: [], // Will store {product, quantity, selected_colors, designType, color_quantities}
            notes: '',
            total: 0
        };
        let loginRole = 'staff';
        const ORDER_STATUSES = ['Pending', 'Processing', 'Completed', 'Cancelled'];

        // --- HELPER FUNCTIONS ---
        function showView(viewId) {
            [loadingView, loginView, adminView, staffView].forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Completed': return 'bg-green-100 text-green-800';
                case 'Processing': return 'bg-blue-100 text-blue-800';
                case 'Cancelled': return 'bg-red-100 text-red-800';
                case 'Pending':
                default:
                    return 'bg-yellow-100 text-yellow-800';
            }
        }


        // --- AUTHENTICATION ---
        async function handleLogin(e) {
            e.preventDefault();
            const password = loginPasswordInput.value;
            loginMessage.textContent = 'Logging in...';

            if (loginRole === 'admin') {
                if (password === ADMIN_PASSWORD) {
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    if (rememberMeCheckbox.checked) {
                        localStorage.setItem('adminPassword', password);
                    } else {
                        localStorage.removeItem('adminPassword');
                    }
                    loginMessage.textContent = '';
                    loginForm.reset();
                    await checkUserSession();
                } else {
                    loginMessage.textContent = 'Error: Invalid password.';
                }
                return;
            }
            
            const email = loginEmailInput.value;
             if (email === ADMIN_EMAIL) {
                loginMessage.textContent = 'Error: Please use the Admin login for this email.';
                return;
            }

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                loginMessage.textContent = `Error: ${error.message}`;
                return;
            }

            if (data.user) {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('staffEmail', email);
                    localStorage.setItem('staffPassword', password);
                    localStorage.removeItem('adminPassword'); 
                } else {
                    localStorage.removeItem('staffEmail');
                    localStorage.removeItem('staffPassword');
                    localStorage.removeItem('adminPassword');
                }
                loginMessage.textContent = '';
                await checkUserSession();
            }
        }

        async function handleLogout() {
            if (currentUser && currentUser.is_admin) {
                sessionStorage.removeItem('isAdminLoggedIn');
            } else {
                await supabase.auth.signOut();
            }
            currentUser = null;
            userDisplay.textContent = '';
            logoutButton.classList.add('hidden');
            appTitle.textContent = 'Saree Ordering System';
            showView('login-view');
        }

        async function checkUserSession() {
            if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                currentUser = { email: ADMIN_EMAIL, is_admin: true };
                userDisplay.textContent = 'Logged in as: Admin';
                logoutButton.classList.remove('hidden');
                appTitle.textContent = 'Admin Panel';
                await initializeAdminView();
                showView('admin-view');
                loadingView.classList.add('hidden');
                return;
            }

            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                userDisplay.textContent = `Logged in as: ${currentUser.email}`;
                logoutButton.classList.remove('hidden');
                
                appTitle.textContent = 'Staff Ordering Panel';
                await initializeStaffView();
                showView('staff-view');
            } else {
                showView('login-view');
            }
            loadingView.classList.add('hidden');
        }

        
        // --- ADMIN PANEL ---
        async function initializeAdminView() {
            if (SUPABASE_SERVICE_KEY === 'PASTE_YOUR_SERVICE_ROLE_KEY_HERE') {
                alert('CRITICAL: Admin functions are disabled. Please paste your Supabase Service Role Key in the index.html file to enable them.');
            }
            await fetchProducts(true);
            renderProductTable();
            await renderOrderDashboard();
            await fetchAndRenderStaffList();
        }

        async function fetchProducts(isAdmin = false) {
            const columns = isAdmin ? '*' : 'id, unique_number, name, rate, image_url, color, description';
            
            let queryBuilder;
            if (isAdmin) {
                const adminSupabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
                queryBuilder = adminSupabase.from('products');
            } else {
                queryBuilder = supabase.from('products');
            }

            const { data, error } = await queryBuilder.select(columns).order('unique_number', { ascending: true });
            
            if (error) {
                console.error('Error fetching products:', error);
                alert('Could not fetch products.');
                return;
            }
            products = data;
        }

        function renderProductTable() {
            productTableBody.innerHTML = '';
            products.forEach(p => {
                const firstImage = p.image_url ? p.image_url.split(',')[0].trim() : 'https://placehold.co/100x100/eee/ccc?text=No+Image';
                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-sm">${p.unique_number}</td>
                        <td class="p-3"><img src="${firstImage}" alt="${p.name}" class="h-16 w-16 object-cover rounded-md shadow"></td>
                        <td class="p-3 font-medium text-gray-800 text-sm">${p.name}</td>
                        <td class="p-3 text-sm">${formatCurrency(p.rate)}</td>
                        <td class="p-3 text-sm">${p.color}</td>
                        <td class="p-3 text-sm">${p.weaver_name}</td>
                        <td class="p-3 max-w-[150px] truncate text-sm">${p.description || ''}</td>
                        <td class="p-3 text-sm">
                            <button data-id="${p.id}" class="edit-product-btn bg-indigo-500 text-white px-3 py-1 rounded-md shadow-sm hover:bg-indigo-600 transition">Edit</button>
                            <button data-id="${p.id}" class="delete-product-btn bg-red-500 text-white px-3 py-1 rounded-md shadow-sm hover:bg-red-600 transition mt-1">Delete</button>
                        </td>
                    </tr>
                `;
                productTableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        async function renderOrderDashboard() {
            orderDashboardContent.innerHTML = '<div class="text-center p-8"><p>Loading orders...</p></div>';
            
            const adminSupabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
            const { data: orders, error } = await adminSupabase
                .from('orders')
                .select(`
                    id, created_at, party_name, total_amount, notes, status,
                    order_items (
                        quantity,
                        selected_color,
                        design_type,
                        color_quantities,
                        products (*)
                    ),
                    profiles (email)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Error fetching orders:", error);
                orderDashboardContent.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert"><p>Error fetching orders: ${error.message}</p></div>`;
                return;
            }

            if (orders.length === 0) {
                orderDashboardContent.innerHTML = '<div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-gray-500">No orders have been placed yet.</p></div>';
                return;
            }

            let html = '';
            for (const order of orders) {
                const totalQuantity = order.order_items.reduce((sum, item) => sum + item.quantity, 0);
                const statusColor = getStatusColor(order.status);

                html += `
                    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-6">
                        <div class="md:flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">${order.party_name}</h3>
                                <p class="text-sm text-gray-500">Order Placed: ${new Date(order.created_at).toLocaleString()}</p>
                                <p class="text-sm text-gray-500">By: ${order.profiles ? order.profiles.email : 'Unknown Staff'}</p>
                            </div>
                            <div class="text-left md:text-right mt-2 md:mt-0">
                                <p class="text-lg md:text-xl font-semibold text-green-600">Total Sale: ${formatCurrency(order.total_amount)}</p>
                                <p class="text-md font-semibold text-gray-600">Total Sarees: ${totalQuantity}</p>
                            </div>
                        </div>
                        
                         <div class="flex flex-col md:flex-row justify-between md:items-center bg-gray-50 p-3 rounded mb-4">
                            <div>
                                <span class="font-bold text-gray-700">Status:</span>
                                <span class="status-badge text-sm font-medium px-2.5 py-0.5 rounded ${statusColor}">${order.status}</span>
                            </div>
                            <div class="mt-2 md:mt-0">
                                <select data-order-id="${order.id}" class="order-status-select bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-auto p-2">
                                    ${ORDER_STATUSES.map(s => `<option value="${s}" ${s === order.status ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="mt-4 bg-gray-50 p-3 rounded">
                            <h4 class="font-bold text-gray-700">Notes:</h4>
                            <p class="text-gray-600 text-sm">${order.notes || 'No notes.'}</p>
                        </div>

                        <div class="mt-4">
                            <h4 class="font-bold text-gray-700 mb-2">Items Ordered:</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-4">
                                ${order.order_items.map(item => {
                                    if (!item.products) return '';
                                    const itemImage = item.products.image_url ? item.products.image_url.split(',')[0].trim() : 'https://placehold.co/100x100/eee/ccc?text=No+Image';
                                    
                                    let colorDetails = '';
                                    if(item.design_type === 'Individual' && item.color_quantities) {
                                        colorDetails = Object.entries(item.color_quantities).map(([color, qty]) => `${color} (x${qty})`).join(', ');
                                    } else {
                                        colorDetails = item.selected_color || '';
                                    }

                                    return `
                                    <div class="border p-2 rounded-lg text-center bg-white hover:shadow-lg transition">
                                        <img src="${itemImage}" class="w-full h-20 md:h-28 object-cover rounded-md mx-auto shadow-sm">
                                        <p class="text-xs md:text-sm font-semibold mt-1 truncate">${item.products.name}</p>
                                        <p class="text-xs text-gray-500">#${item.products.unique_number}</p>
                                        <p class="text-xs font-semibold text-gray-600">${item.design_type || 'Mix'}</p>
                                        <p class="text-xs font-medium text-gray-800 truncate" title="${colorDetails}">${colorDetails}</p>
                                        <p class="text-xs md:text-sm font-bold text-indigo-600">${item.quantity} x ${formatCurrency(item.products.rate)}</p>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            orderDashboardContent.innerHTML = html;
        }

        async function handleOrderStatusChange(orderId, newStatus) {
            const adminSupabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
            const { error } = await adminSupabase
                .from('orders')
                .update({ status: newStatus })
                .eq('id', orderId);

            if (error) {
                console.error("Error updating status:", error);
                alert('Could not update order status.');
            } else {
                const selectEl = document.querySelector(`select[data-order-id="${orderId}"]`);
                const statusBadge = selectEl.closest('div.flex').querySelector('.status-badge');
                statusBadge.textContent = newStatus;
                statusBadge.className = `status-badge text-sm font-medium px-2.5 py-0.5 rounded ${getStatusColor(newStatus)}`;
            }
        }

        function openProductModal(product = null) {
            productFormInModal.reset();
            productIdInput.value = '';

            const dynamicImageInputs = imageUrlsContainer.querySelectorAll('.dynamic-image-input');
            dynamicImageInputs.forEach(input => input.remove());

            if (product) {
                productModalTitle.textContent = 'Edit Saree';
                productIdInput.value = product.id;
                document.getElementById('product-unique_number').value = product.unique_number;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-rate').value = product.rate;
                document.getElementById('product-color').value = product.color;
                document.getElementById('product-weaver_name').value = product.weaver_name;
                document.getElementById('product-description').value = product.description || '';

                const firstImageInput = imageUrlsContainer.querySelector('input[name="image_url"]');
                const urls = product.image_url ? product.image_url.split(',') : [];
                firstImageInput.value = urls[0] || '';
                if (urls.length > 1) {
                    urls.slice(1).forEach(url => addImageUrlInput(url));
                }
            } else {
                productModalTitle.textContent = 'Add New Saree';
                imageUrlsContainer.querySelector('input[name="image_url"]').value = '';
            }
            productModal.classList.remove('hidden');
        }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());

            const imageUrlInputs = productFormInModal.querySelectorAll('input[name="image_url"]');
            const imageUrls = Array.from(imageUrlInputs).map(input => input.value.trim()).filter(url => url);
            productData.image_url = imageUrls.join(',');
            
            const id = productData.id;
            delete productData.id;
            productData.rate = parseFloat(productData.rate);
            
            const adminSupabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
            let error;
            if (id) {
                const { error: updateError } = await adminSupabase.from('products').update(productData).eq('id', id);
                error = updateError;
            } else {
                const { error: insertError } = await adminSupabase.from('products').insert([productData]);
                error = insertError;
            }

            if (error) {
                console.error('Error saving product:', error);
                alert(`Error: ${error.message}`);
            } else {
                productModal.classList.add('hidden');
                await fetchProducts(true);
                renderProductTable();
            }
        }
        
        async function handleDeleteProduct(id) {
            if (!confirm('Are you sure you want to delete this saree? This action cannot be undone.')) return;
            
            const adminSupabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
            const { error } = await adminSupabase.from('products').delete().eq('id', id);

            if (error) {
                console.error('Error deleting product:', error);
                alert(`Error: ${error.message}`);
            } else {
                await fetchProducts(true);
                renderProductTable();
            }
        }

        async function handleStaffRegistration(e) {
            e.preventDefault();
            const name = document.getElementById('staff-name').value;
            const email = document.getElementById('staff-email').value;
            const password = document.getElementById('staff-password').value;
            
            staffMessage.textContent = 'Registering...';
            staffMessage.className = 'mt-4 text-center font-medium text-gray-600';

            const adminSupabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
            const { data, error } = await adminSupabase.auth.admin.createUser({
                email,
                password,
                email_confirm: true,
                user_metadata: { full_name: name }
            });

            if (error) {
                staffMessage.textContent = `Error: ${error.message}`;
                staffMessage.className = 'mt-4 text-center font-medium text-red-500';
            } else if (data.user) {
                staffMessage.textContent = 'Staff registered successfully!';
                staffMessage.className = 'mt-4 text-center font-medium text-green-500';
                addStaffForm.reset();
                await fetchAndRenderStaffList();
            }
        }

        async function fetchAndRenderStaffList() {
            staffListContainer.innerHTML = '<p>Loading staff...</p>';
            
            const adminSupabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
            const { data, error } = await adminSupabase.from('profiles').select('full_name, email');

            if (error) {
                staffListContainer.innerHTML = '<p class="text-red-500">Could not load staff list.</p>';
                console.error("Error fetching staff:", error);
                return;
            }

            const staffList = data.filter(profile => profile.email !== ADMIN_EMAIL);
            if (staffList.length === 0) {
                staffListContainer.innerHTML = '<p class="text-gray-500">No staff members have been added yet.</p>';
                return;
            }

            staffListContainer.innerHTML = `
                <ul class="divide-y divide-gray-200">
                    ${staffList.map(staff => `
                        <li class="py-3 flex justify-between items-center">
                            <div>
                                <p class="font-medium text-gray-800">${staff.full_name || 'Name not set'}</p>
                                <p class="text-sm text-gray-500">${staff.email}</p>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        function handleChangePassword(e) {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            if (newPassword.length < 6) {
                changePasswordMessage.textContent = 'Password must be at least 6 characters long.';
                changePasswordMessage.className = 'mt-4 text-center font-medium text-red-500';
                return;
            }
            ADMIN_PASSWORD = newPassword; // Temporarily update for the current session
            changePasswordMessage.innerHTML = `
                <p class="text-green-600">Password updated for this session!</p>
                <p class="mt-2 text-sm text-gray-700">For this change to be permanent, please open the <b>index.html</b> file and update the ADMIN_PASSWORD variable like this:</p>
                <pre class="bg-gray-200 p-2 rounded mt-1 text-xs text-left">let ADMIN_PASSWORD = '${newPassword}';</pre>
            `;
            changePasswordMessage.className = 'mt-4 text-center font-medium';
            changePasswordForm.reset();
        }


        // --- STAFF PANEL ---
        async function initializeStaffView() {
            resetOrder();
            await fetchProducts(false);
            renderStaffProductGrid();
            await fetchAndRenderStaffOrders(); // Fetch orders on initial load
        }

        function renderStaffProductGrid(filteredProducts = products) {
            staffProductGrid.innerHTML = '';
             filteredProducts.forEach(p => {
                const isAdded = currentOrder.items.some(item => item.product.id === p.id);
                const buttonHtml = isAdded
                    ? `<button class="w-full bg-gray-400 text-white font-bold py-2 px-4 rounded-lg mt-2 cursor-not-allowed" disabled>Added</button>`
                    : `<button data-id="${p.id}" class="open-add-modal-btn w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-2 px-4 rounded-lg mt-2 hover:from-green-600 hover:to-emerald-700 shadow-lg transform hover:scale-105 transition-all duration-200">Add to Order</button>`;
                
                const imageUrls = p.image_url ? p.image_url.split(',').map(url => url.trim()).filter(url => url) : ['https://placehold.co/400x400/eee/ccc?text=No+Image'];

                const imageCarouselHtml = `
                    <div class="relative w-full h-52 mb-3 image-carousel bg-gray-100 rounded-lg" data-product-id="${p.id}" data-images='${JSON.stringify(imageUrls)}' data-current-index="0">
                        <img src="${imageUrls[0]}" alt="${p.name}" class="w-full h-full object-contain rounded-lg">
                        ${imageUrls.length > 1 ? `
                            <div class="image-count-indicator absolute bottom-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-full">1 / ${imageUrls.length}</div>
                        ` : ''}
                    </div>
                `;

                const card = `
                    <div id="product-card-${p.id}" class="border rounded-xl p-4 shadow-lg bg-white transition-transform transform hover:-translate-y-1 duration-300 flex flex-col">
                        ${imageCarouselHtml}
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-gray-800">${p.name}</h3>
                            <div class="flex justify-between items-center text-sm text-gray-500 mt-1">
                              <span>#${p.unique_number}</span>
                            </div>
                        </div>
                        <div class="mt-auto pt-2">
                          <p class="font-semibold text-2xl text-primary mt-2">${formatCurrency(p.rate)}</p>
                          ${buttonHtml}
                        </div>
                    </div>
                `;
                staffProductGrid.insertAdjacentHTML('beforeend', card);
            });
        }

        async function fetchAndRenderStaffOrders() {
            if (!currentUser) return;
            myOrdersContent.innerHTML = '<p>Loading your orders...</p>';

            const { data: orders, error } = await supabase
                .from('orders')
                .select(`
                    id, created_at, party_name, total_amount, status, notes,
                    order_items ( quantity, selected_color, design_type, color_quantities, products (name, unique_number) )
                `)
                .eq('staff_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                myOrdersContent.innerHTML = `<p class="text-red-500">Could not load orders: ${error.message}</p>`;
                return;
            }

            if (orders.length === 0) {
                myOrdersContent.innerHTML = '<p class="text-gray-500">You have not placed any orders yet.</p>';
                return;
            }

            myOrdersContent.innerHTML = orders.map(order => {
                const statusColor = getStatusColor(order.status);
                
                const itemsHtml = order.order_items.map(item => {
                     let colorDetails = '';
                    if(item.design_type === 'Individual' && item.color_quantities) {
                        colorDetails = Object.entries(item.color_quantities).map(([color, qty]) => `<span class="ml-4 block">- ${color} (Qty: ${qty})</span>`).join('');
                    } else {
                        colorDetails = `<span class="ml-4 block">- ${item.selected_color} (Total Qty: ${item.quantity})</span>`;
                    }
                    return `
                        <div class="mt-2">
                            <p class="font-semibold text-gray-700">${item.products.name} (#${item.products.unique_number}) - <span class="font-normal">${item.design_type}</span></p>
                            <div class="text-sm text-gray-600">${colorDetails}</div>
                        </div>
                    `
                }).join('');

                return `
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${order.party_name}</p>
                                <p class="text-sm text-gray-500">${new Date(order.created_at).toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-primary">${formatCurrency(order.total_amount)}</p>
                                <span class="text-xs font-medium px-2.5 py-0.5 rounded mt-2 inline-block ${statusColor}">${order.status}</span>
                            </div>
                        </div>
                        <div class="mt-3 border-t pt-3">
                            <h4 class="font-semibold text-sm">Items:</h4>
                            ${itemsHtml}
                        </div>
                    </div>
                `
            }).join('');
        }

        function openAddToOrderModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const modalTitle = addToOrderModal.querySelector('#add-modal-title');
            const form = addToOrderModal.querySelector('form');
            form.dataset.productId = productId;
            form.reset();

            modalTitle.textContent = `${product.name} (#${product.unique_number})`;

            const designTypeRadios = form.querySelectorAll('input[name="add-modal-design-type"]');
            const mixOptions = form.querySelector('#add-modal-mix-options');
            const individualOptions = form.querySelector('#add-modal-individual-options');

            // Populate color options for both sections
            const colors = product.color.split(',').map(c => c.trim());
            const mixColorHtml = colors.map(c => `
                 <div>
                    <input type="checkbox" name="add-modal-mix-color" id="mix-color-${c}" value="${c}" class="hidden peer">
                    <label for="mix-color-${c}" class="text-sm font-semibold text-gray-700 px-3 py-1 rounded-full border-2 border-gray-300 cursor-pointer peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary transition">${c}</label>
                </div>
            `).join('');
            form.querySelector('#add-modal-mix-colors').innerHTML = mixColorHtml;

            const individualColorHtml = colors.map(c => `
                <div class="flex justify-between items-center">
                    <label for="individual-qty-${c}" class="text-sm font-medium text-gray-700">${c}</label>
                    <input type="number" name="individual-qty" data-color="${c}" id="individual-qty-${c}" min="0" value="0" class="w-20 text-center border border-gray-300 rounded-md">
                </div>
            `).join('');
            individualOptions.querySelector('#add-modal-individual-colors').innerHTML = individualColorHtml;


            function toggleDesignView() {
                if (form.querySelector('input[name="add-modal-design-type"]:checked').value === 'Mix') {
                    mixOptions.classList.remove('hidden');
                    individualOptions.classList.add('hidden');
                } else {
                    mixOptions.classList.add('hidden');
                    individualOptions.classList.remove('hidden');
                }
            }

            designTypeRadios.forEach(radio => radio.addEventListener('change', toggleDesignView));
            
            toggleDesignView();
            addToOrderModal.classList.remove('hidden');
        }

        function handleAddToOrderFromModal(e) {
            e.preventDefault();
            const form = e.target;
            const productId = parseInt(form.dataset.productId, 10);
            const product = products.find(p => p.id === productId);

            const partyName = currentOrderPartyName.value.trim();
            if (!partyName) {
                alert('Please enter a Party Name before adding items.');
                currentOrderPartyName.focus();
                addToOrderModal.classList.add('hidden');
                return;
            }

            if(currentOrder.partyName && currentOrder.partyName !== partyName) {
                if(!confirm('Changing party name will clear the current order. Continue?')) {
                    currentOrderPartyName.value = currentOrder.partyName;
                    addToOrderModal.classList.add('hidden');
                    return;
                }
                resetOrder();
                currentOrderPartyName.value = partyName;
            }
            currentOrder.partyName = partyName;

            const designType = form.querySelector('input[name="add-modal-design-type"]:checked').value;
            
            let totalQuantity = 0;
            let selected_colors = [];
            let color_quantities = {};

            if (designType === 'Mix') {
                const colorCheckboxes = form.querySelectorAll('input[name="add-modal-mix-color"]:checked');
                if (colorCheckboxes.length === 0) {
                    alert('Please select at least one color for Mix Design.');
                    return;
                }
                selected_colors = Array.from(colorCheckboxes).map(cb => cb.value);
                totalQuantity = parseInt(form.querySelector('#add-modal-mix-quantity').value, 10) || 0;
                if (totalQuantity <= 0) {
                    alert('Please enter a quantity greater than zero for Mix Design.');
                    return;
                }
            } else { // Individual
                const qtyInputs = form.querySelectorAll('input[name="individual-qty"]');
                qtyInputs.forEach(input => {
                    const qty = parseInt(input.value, 10) || 0;
                    if (qty > 0) {
                        const color = input.dataset.color;
                        color_quantities[color] = qty;
                        selected_colors.push(color);
                        totalQuantity += qty;
                    }
                });
                if (totalQuantity <= 0) {
                    alert('Please enter a quantity for at least one color for Individual Design.');
                    return;
                }
            }

            currentOrder.items.push({
                product,
                quantity: totalQuantity,
                selected_colors,
                designType,
                color_quantities: designType === 'Individual' ? color_quantities : null
            });

            updateCurrentOrderDisplay();
            renderStaffProductGrid(products.filter(p => p.unique_number.toString().includes(staffSearchInput.value)));
            addToOrderModal.classList.add('hidden');
        }
        
        function handleRemoveFromOrder(productId) {
            currentOrder.items = currentOrder.items.filter(item => item.product.id !== productId);
            updateCurrentOrderDisplay();
            renderStaffProductGrid(products.filter(p => p.unique_number.toString().includes(staffSearchInput.value)));
        }

        function updateCurrentOrderDisplay() {
            currentOrderItems.innerHTML = '';
            let total = 0;
            if (currentOrder.items.length === 0) {
                currentOrderItems.innerHTML = '<p class="text-gray-500 text-center py-4">No items added yet.</p>';
            } else {
                 currentOrder.items.forEach(item => {
                    total += item.product.rate * item.quantity;
                    let colorDetails = '';
                     if(item.designType === 'Individual' && item.color_quantities) {
                        colorDetails = Object.entries(item.color_quantities).map(([color, qty]) => `${color}(${qty})`).join(', ');
                    } else {
                        colorDetails = item.selected_colors.join(', ');
                    }

                    const itemHtml = `
                        <li class="py-3 border-b border-gray-200">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-gray-800">${item.product.name} (#${item.product.unique_number})</p>
                                    <p class="text-sm text-gray-500 font-medium">${colorDetails}</p>
                                    <p class="text-xs text-gray-500">${item.designType} Design</p>
                                </div>
                                <button data-id="${item.product.id}" class="remove-from-order-btn text-red-500 hover:text-red-700 font-bold text-xl flex-shrink-0">&times;</button>
                            </div>
                             <div class="text-right font-semibold text-gray-700 mt-1">${item.quantity} x ${formatCurrency(item.product.rate)}</div>
                        </li>
                    `;
                    currentOrderItems.insertAdjacentHTML('beforeend', itemHtml);
                });
            }
            currentOrder.total = total;
            currentOrderTotal.textContent = formatCurrency(total);
        }

        async function handleSubmitOrder() {
            if (!currentOrder.partyName || currentOrder.items.length === 0) {
                alert('Please provide a party name and add at least one item.');
                return;
            }
            
            submitOrderButton.disabled = true;
            submitOrderButton.textContent = 'Submitting...';
            orderMessage.textContent = '';
            
            const { data: orderData, error: orderError } = await supabase
                .from('orders')
                .insert({
                    party_name: currentOrder.partyName,
                    notes: currentOrderNotes.value,
                    total_amount: currentOrder.total,
                    staff_id: currentUser.id
                })
                .select()
                .single();

            if (orderError) {
                console.error('Error creating order:', orderError);
                orderMessage.textContent = `Error: ${orderError.message}`;
                orderMessage.className = 'mt-4 text-center font-semibold text-red-500';
                submitOrderButton.disabled = false;
                submitOrderButton.textContent = 'Submit Order';
                return;
            }
            
            const orderItemsData = currentOrder.items.map(item => ({
                order_id: orderData.id,
                product_id: item.product.id,
                quantity: item.quantity,
                selected_color: item.selected_colors.join(', '),
                design_type: item.designType,
                color_quantities: item.color_quantities
            }));
            
            const { error: itemsError } = await supabase.from('order_items').insert(orderItemsData);
            
            if (itemsError) {
                console.error('Error adding order items:', itemsError);
                await supabase.from('orders').delete().eq('id', orderData.id);
                orderMessage.textContent = `Error saving items. Order cancelled.`;
                orderMessage.className = 'mt-4 text-center font-semibold text-red-500';
            } else {
                orderMessage.textContent = 'Order submitted successfully!';
                orderMessage.className = 'mt-4 text-center font-semibold text-green-500';
                resetOrder();
                renderStaffProductGrid();
                await fetchAndRenderStaffOrders(); // Refresh order history
            }

            setTimeout(() => { orderMessage.textContent = '' }, 5000);
            submitOrderButton.disabled = false;
            submitOrderButton.textContent = 'Submit Order';
        }
        
        function resetOrder() {
            currentOrder = { partyName: '', items: [], notes: '', total: 0 };
            currentOrderPartyName.value = '';
            currentOrderNotes.value = '';
            staffSearchInput.value = '';
            updateCurrentOrderDisplay();
        }

        function populateLoginFormFromStorage() {
            if (loginRole === 'staff') {
                const savedEmail = localStorage.getItem('staffEmail');
                const savedPassword = localStorage.getItem('staffPassword');
                if (savedEmail && savedPassword) {
                    loginEmailInput.value = savedEmail;
                    loginPasswordInput.value = savedPassword;
                    rememberMeCheckbox.checked = true;
                } else {
                    loginEmailInput.value = '';
                    loginPasswordInput.value = '';
                    rememberMeCheckbox.checked = false;
                }
            } else { // admin
                const savedPassword = localStorage.getItem('adminPassword');
                loginEmailInput.value = ADMIN_EMAIL;
                if (savedPassword) {
                    loginPasswordInput.value = savedPassword;
                    rememberMeCheckbox.checked = true;
                } else {
                    loginPasswordInput.value = '';
                    rememberMeCheckbox.checked = false;
                }
            }
        }

        function addImageUrlInput(url = '') {
            const div = document.createElement('div');
            div.className = 'flex items-center mt-2 dynamic-image-input';
            div.innerHTML = `
                <input type="url" name="image_url" value="${url}" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                <button type="button" class="remove-image-btn ml-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                </button>
            `;
            imageUrlsContainer.appendChild(div);
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('DOMContentLoaded', () => {
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);

            document.getElementById('add-image-btn').addEventListener('click', () => addImageUrlInput());

            imageUrlsContainer.addEventListener('click', e => {
                if (e.target.closest('.remove-image-btn')) {
                    e.target.closest('.dynamic-image-input').remove();
                }
            });

            roleSwitcherBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    roleSwitcherBtns.forEach(b => b.classList.remove('bg-primary', 'text-white'));
                    btn.classList.add('bg-primary', 'text-white');
                    loginRole = btn.dataset.role;
                    loginTitle.textContent = `${loginRole.charAt(0).toUpperCase() + loginRole.slice(1)} Login`;
                    
                    if (loginRole === 'admin') {
                        emailInputWrapper.classList.add('hidden');
                    } else {
                        emailInputWrapper.classList.remove('hidden');
                    }
                    populateLoginFormFromStorage();
                });
            });
            
            // Admin listeners
            adminTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    adminTabs.forEach(t => t.classList.remove('border-primary', 'text-primary'));
                    tab.classList.add('border-primary', 'text-primary');
                    adminPanels.forEach(panel => panel.classList.add('hidden'));
                    document.getElementById(tab.dataset.target).classList.remove('hidden');
                });
            });
            
            document.getElementById('add-product-btn').addEventListener('click', () => openProductModal());
            cancelModalButton.addEventListener('click', () => productModal.classList.add('hidden'));
            productFormInModal.addEventListener('submit', handleProductFormSubmit);
            addStaffForm.addEventListener('submit', handleStaffRegistration);
            changePasswordForm.addEventListener('submit', handleChangePassword);
            
            productTableBody.addEventListener('click', e => {
                if (e.target.closest('.edit-product-btn')) {
                    const id = parseInt(e.target.closest('.edit-product-btn').dataset.id);
                    const product = products.find(p => p.id === id);
                    openProductModal(product);
                }
                if (e.target.closest('.delete-product-btn')) {
                    const id = parseInt(e.target.closest('.delete-product-btn').dataset.id);
                    handleDeleteProduct(id);
                }
            });

            orderDashboardContent.addEventListener('change', e => {
                if(e.target.classList.contains('order-status-select')) {
                    const orderId = e.target.dataset.orderId;
                    const newStatus = e.target.value;
                    handleOrderStatusChange(orderId, newStatus);
                }
            });

            // Staff listeners
            staffTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    staffTabs.forEach(t => t.classList.remove('border-primary', 'text-primary'));
                    tab.classList.add('border-primary', 'text-primary');
                    staffPanels.forEach(panel => panel.classList.add('hidden'));
                    document.getElementById(tab.dataset.target).classList.remove('hidden');

                    if (tab.dataset.target === 'my-orders-panel') {
                        fetchAndRenderStaffOrders();
                    }
                });
            });


            staffSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = products.filter(p => p.unique_number.toString().toLowerCase().includes(searchTerm));
                renderStaffProductGrid(filtered);
            });
            
            let touchstartX = 0;
            let touchendX = 0;

            function handleSwipe(carousel, direction) {
                const images = JSON.parse(carousel.dataset.images);
                if (images.length <= 1) return;
                
                let currentIndex = parseInt(carousel.dataset.currentIndex, 10);
                currentIndex = (currentIndex + direction + images.length) % images.length;
                
                carousel.querySelector('img').src = images[currentIndex];
                carousel.dataset.currentIndex = currentIndex;
                carousel.querySelector('.image-count-indicator').textContent = `${currentIndex + 1} / ${images.length}`;
            }

            staffProductGrid.addEventListener('touchstart', e => {
                if (e.target.closest('.image-carousel')) {
                    touchstartX = e.changedTouches[0].screenX;
                }
            }, {passive: true});

            staffProductGrid.addEventListener('touchend', e => {
                if (e.target.closest('.image-carousel')) {
                    touchendX = e.changedTouches[0].screenX;
                    const carousel = e.target.closest('.image-carousel');
                    if (touchendX < touchstartX) handleSwipe(carousel, 1); // Swiped left
                    if (touchendX > touchstartX) handleSwipe(carousel, -1); // Swiped right
                }
            });

            staffProductGrid.addEventListener('click', e => {
                if (e.target.closest('.open-add-modal-btn')) {
                    const id = parseInt(e.target.closest('.open-add-modal-btn').dataset.id);
                    openAddToOrderModal(id);
                }
                if (e.target.closest('.carousel-btn')) {
                    const button = e.target.closest('.carousel-btn');
                    const carousel = button.closest('.image-carousel');
                    const direction = parseInt(button.dataset.direction, 10);
                    handleSwipe(carousel, direction);
                }
            });
            
            currentOrderItems.addEventListener('click', e => {
                if (e.target.closest('.remove-from-order-btn')) {
                    const id = parseInt(e.target.closest('.remove-from-order-btn').dataset.id);
                    handleRemoveFromOrder(id);
                }
            });

            submitOrderButton.addEventListener('click', handleSubmitOrder);

            addToOrderModal.querySelector('form').addEventListener('submit', handleAddToOrderFromModal);
            addToOrderModal.querySelector('#cancel-add-modal-button').addEventListener('click', () => {
                addToOrderModal.classList.add('hidden');
            });


            populateLoginFormFromStorage();
            checkUserSession();
        });

    </script>
</head>
<body class="bg-slate-100 font-sans">
    <header class="bg-white shadow-md sticky top-0 z-20">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <h1 id="app-title" class="text-xl md:text-2xl font-bold text-gray-800">Saree Ordering System</h1>
            <div>
                <span id="user-display" class="text-gray-700 mr-4 text-sm md:text-base"></span>
                <button id="logout-button" class="bg-red-500 text-white px-3 py-1 md:px-4 md:py-2 rounded-lg shadow hover:bg-red-600 transition hidden">Logout</button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-6">
        <!-- Loading View -->
        <div id="loading-view">
            <p class="text-center text-xl mt-10">Loading application...</p>
        </div>

        <!-- Login View -->
        <div id="login-view" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl mt-10 hidden">
            <div class="mb-6">
                <div class="flex border border-gray-300 rounded-lg p-1">
                    <button data-role="staff" class="role-switcher-btn w-1/2 p-2 rounded-md text-center font-semibold transition bg-primary text-white">Staff</button>
                    <button data-role="admin" class="role-switcher-btn w-1/2 p-2 rounded-md text-center font-semibold transition">Admin</button>
                </div>
            </div>
            <h2 id="login-title" class="text-3xl font-bold text-center mb-6 text-gray-800">Staff Login</h2>
            <form id="login-form">
                <div id="email-input-wrapper" class="mb-4">
                    <label for="login-email" class="block text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-primary focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                    </div>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-700 transition shadow-lg">Login</button>
                <p id="login-message" class="text-red-500 mt-4 text-center font-medium"></p>
            </form>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="hidden">
            <div class="border-b border-gray-200 bg-white rounded-t-lg p-2 overflow-x-auto">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button data-target="order-dashboard" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-primary text-primary">Order Dashboard</button>
                    <button data-target="product-management" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Manage Sarees</button>
                    <button data-target="staff-management" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Manage Staff</button>
                    <button data-target="settings" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Settings</button>
                </nav>
            </div>
            
            <div id="order-dashboard" class="admin-panel mt-6">
                <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">All Orders</h2>
                <div id="order-dashboard-content"></div>
            </div>

            <div id="product-management" class="admin-panel mt-6 hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-0">Saree Inventory</h2>
                    <button id="add-product-btn" class="bg-secondary text-white px-5 py-2 rounded-lg shadow hover:bg-emerald-600 transition font-semibold w-full md:w-auto">Add New Saree</button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr class="border-b">
                                <th class="p-3 text-sm">Unique No.</th>
                                <th class="p-3 text-sm">Image</th>
                                <th class="p-3 text-sm">Name</th>
                                <th class="p-3 text-sm">Rate</th>
                                <th class="p-3 text-sm">Color</th>
                                <th class="p-3 text-sm">Weaver Name</th>
                                <th class="p-3 text-sm">Description</th>
                                <th class="p-3 text-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="staff-management" class="admin-panel mt-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Add Staff Form -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Add New Staff</h3>
                        <form id="add-staff-form">
                            <div class="mb-4">
                                <label for="staff-name" class="block text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="staff-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            </div>
                            <div class="mb-4">
                                <label for="staff-email" class="block text-gray-700 mb-1">Email</label>
                                <input type="email" id="staff-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            </div>
                            <div class="mb-4">
                                <label for="staff-password" class="block text-gray-700 mb-1">Password</label>
                                <input type="password" id="staff-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            </div>
                            <button type="submit" class="w-full bg-secondary text-white py-3 rounded-lg font-bold text-lg hover:bg-emerald-600 transition shadow-lg">Register Staff</button>
                            <p id="staff-message" class="mt-4 text-center font-medium"></p>
                        </form>
                    </div>
                    <!-- Staff List -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Current Staff</h3>
                        <div id="staff-list-container" class="max-h-96 overflow-y-auto">
                            <!-- Staff list will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings" class="admin-panel mt-6 hidden">
                <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Change Admin Password</h3>
                    <p class="text-sm text-gray-600 mb-4">Because this is a secure, file-based application, you must change the password directly in the code. This form will help you do that.</p>
                    <form id="change-password-form">
                        <div class="mb-4">
                            <label for="new-password" class="block text-gray-700 mb-1">New Password</label>
                            <input type="password" id="new-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" required>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition">Update Password</button>
                        <div id="change-password-message" class="mt-4 text-center font-medium"></div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Product Modal -->
        <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30">
            <div class="bg-white rounded-lg p-6 md:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <h3 id="product-modal-title" class="text-2xl font-bold mb-6">Add New Saree</h3>
                <form id="product-form-in-modal">
                    <input type="hidden" id="product-id" name="id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="product-unique_number" class="block text-sm font-medium text-gray-700">Unique Number</label>
                            <input type="text" name="unique_number" id="product-unique_number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                        </div>
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-gray-700">Saree Name</label>
                            <input type="text" name="name" id="product-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="product-rate" class="block text-sm font-medium text-gray-700">Rate (INR)</label>
                            <input type="number" name="rate" id="product-rate" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="product-color" class="block text-sm font-medium text-gray-700">Colors (comma-separated)</label>
                            <input type="text" name="color" id="product-color" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                         <div class="col-span-1 md:col-span-2">
                            <label for="product-image_url" class="block text-sm font-medium text-gray-700">Image URLs</label>
                            <div id="image-urls-container">
                                <div class="flex items-center mt-1">
                                    <input type="url" name="image_url" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                                    <button type="button" id="add-image-btn" class="ml-2 bg-green-500 text-white p-2 rounded-full hover:bg-green-600 flex items-center justify-center flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="product-weaver_name" class="block text-sm font-medium text-gray-700">Weaver Name (Admin Only)</label>
                            <input type="text" name="weaver_name" id="product-weaver_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="product-description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea name="description" id="product-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button type="button" id="cancel-modal-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Saree</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Staff View -->
        <div id="staff-view" class="hidden">
             <div class="border-b border-gray-200 bg-white rounded-t-lg p-2 mb-4">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button data-target="new-order-panel" class="staff-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-primary text-primary">New Order</button>
                    <button data-target="my-orders-panel" class="staff-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">My Orders</button>
                </nav>
            </div>

            <div id="new-order-panel" class="staff-panel bg-indigo-50 p-2 md:p-6 rounded-xl">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Product Grid -->
                    <div class="lg:col-span-2">
                        <div class="mb-4">
                            <input type="search" id="staff-search-input" placeholder="Search by Unique Code..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div id="staff-product-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6">
                            <!-- Product cards will be injected here -->
                        </div>
                    </div>

                    <!-- Current Order -->
                    <div class="lg:sticky lg:top-24 h-fit">
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-2xl">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">Current Order</h2>
                            <div class="mb-4">
                                <label for="current-order-party-name" class="block text-gray-700 font-semibold mb-1">Party Name</label>
                                <input type="text" id="current-order-party-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Enter party or client name">
                            </div>
                            <div class="mb-4">
                                <h3 class="font-semibold mb-2 text-gray-800">Items</h3>
                                <ul id="current-order-items" class="max-h-60 overflow-y-auto pr-2">
                                <p class="text-gray-500 text-center py-4">No items added yet.</p>
                                </ul>
                            </div>
                            <div class="border-t-2 border-dashed pt-4 mb-4">
                                <div class="flex justify-between items-center text-xl font-bold text-gray-800">
                                    <span>Total:</span>
                                    <span id="current-order-total" class="text-primary">₹0.00</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="current-order-notes" class="block text-gray-700 font-semibold mb-1">Notes</label>
                                <textarea id="current-order-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Add any special requests..."></textarea>
                            </div>
                            <button id="submit-order-button" class="w-full bg-gradient-to-r from-primary to-indigo-600 text-white py-3 rounded-lg text-lg font-bold hover:from-indigo-600 hover:to-indigo-700 shadow-xl transform hover:scale-105 transition-all duration-300">Submit Order</button>
                            <p id="order-message" class="mt-4 text-center font-semibold"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="my-orders-panel" class="staff-panel hidden">
                <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">My Order History</h2>
                <div id="my-orders-content">
                    <!-- Staff orders will be rendered here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Add to Order Modal -->
    <div id="add-to-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg p-6 md:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h3 id="add-modal-title" class="text-2xl font-bold mb-4">Add Saree to Order</h3>
            <form>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Design Type</label>
                    <div class="flex gap-4">
                        <div>
                            <input type="radio" name="add-modal-design-type" id="add-modal-design-type-mix" value="Mix" class="hidden peer" checked>
                            <label for="add-modal-design-type-mix" class="px-4 py-2 rounded-lg border-2 border-gray-300 cursor-pointer peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary">Mix Design</label>
                        </div>
                        <div>
                            <input type="radio" name="add-modal-design-type" id="add-modal-design-type-individual" value="Individual" class="hidden peer">
                            <label for="add-modal-design-type-individual" class="px-4 py-2 rounded-lg border-2 border-gray-300 cursor-pointer peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary">Individual</label>
                        </div>
                    </div>
                </div>

                <!-- Mix Design Options -->
                <div id="add-modal-mix-options">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Select Colors</label>
                        <div id="add-modal-mix-colors" class="flex flex-wrap gap-2">
                            <!-- Colors injected here -->
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="add-modal-mix-quantity" class="block text-gray-700 font-semibold mb-2">Total Quantity</label>
                        <input type="number" id="add-modal-mix-quantity" min="1" value="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <!-- Individual Design Options -->
                <div id="add-modal-individual-options" class="hidden">
                     <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Enter Quantity for Each Color</label>
                        <div id="add-modal-individual-colors" class="space-y-2">
                            <!-- Color quantities injected here -->
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancel-add-modal-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-secondary text-white px-4 py-2 rounded-lg hover:bg-emerald-600 transition">Add to Order</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>

